<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>My Watchlist - MoodFlix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        .watchlist-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            padding: var(--content-padding);
        }
        
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .watchlist-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text);
            margin: 0;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .filter-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .filter-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }
        
        .filter-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        .folder-section {
            margin-bottom: 1.5rem;
            animation: slideUp 0.5s ease forwards;
            background-color: rgba(30, 30, 30, 0.3);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .folder-header:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .folder-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .folder-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .folder-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .folder-btn {
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
        }
        
        .folder-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }
        
        .folder-content {
            padding: 1.5rem;
            transition: all 0.3s ease;
            height: auto;
            opacity: 1;
            display: block;
        }
        
        .folder-section.collapsed .folder-content {
            height: 0;
            opacity: 0;
            padding: 0;
            display: none;
        }
        
        .toggle-folder {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform var(--transition-fast), color var(--transition-fast);
        }
        
        .toggle-folder:hover {
            color: var(--text);
        }
        
        .folder-section.collapsed .toggle-folder {
            transform: rotate(-90deg);
        }
        
        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .watchlist-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            transition: all var(--transition-normal);
            position: relative;
            box-shadow: var(--shadow-light);
            height: 100%;
            display: flex;
            flex-direction: column;
            cursor: pointer; /* Add cursor pointer to indicate it's clickable */
        }
        
        .watchlist-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            background-color: var(--card-hover-bg);
        }
        
        .watchlist-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }
        
        .watchlist-info {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .watchlist-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.5rem 0;
            line-height: 1.3;
        }
        
        .watchlist-genre {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0 0 0.5rem 0;
        }
        
        .watchlist-rating {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .watchlist-rating::before {
            content: "★";
            color: #ffc107;
        }
        
        .watchlist-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            z-index: 2;
        }
        
        .watched-badge {
            background-color: #2ecc71;
        }
        
        .unwatched-badge {
            background-color: var(--primary);
        }
        
        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 0.5rem;
            padding-top: 0.5rem;
            flex-wrap: wrap;
        }
        
        .card-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
            min-width: calc(50% - 0.25rem);
            transition: all var(--transition-fast);
            text-align: center;
            white-space: nowrap;
        }
        
        .card-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }
        
        .card-btn.primary {
            background-color: var(--primary);
            color: white;
        }
        
        .card-btn.primary:hover {
            background-color: var(--primary-hover);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .empty-state p {
            margin-bottom: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .empty-state-btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition-fast);
        }
        
        .empty-state-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            box-shadow: var(--shadow-strong);
            animation: slideUp 0.4s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        
        .modal-close:hover {
            color: var(--primary);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-sm);
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .modal-btn.cancel {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }
        
        .modal-btn.cancel:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-btn.confirm {
            background-color: var(--primary);
            color: white;
        }
        
        .modal-btn.confirm:hover {
            background-color: var(--primary-hover);
        }
        
        .modal-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-sm);
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .modal-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            border-left: 4px solid #2ecc71;
        }
        
        .toast.error {
            border-left: 4px solid var(--primary);
        }
        
        .create-folder-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .create-folder-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .folder-icon {
            font-size: 1.2rem;
        }
        
        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .star {
            color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color var(--transition-fast);
        }
        
        .star.active {
            color: #ffc107;
        }
        
        .star:hover {
            color: #ffc107;
        }
        
        .rating-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .rating-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            position: relative;
        }

        .rating-label-text {
            position: relative;
            cursor: pointer;
        }

        .rating-value {
            color: var(--text);
            font-weight: 600;
        }

        .rating-value.unwatched {
            color: var(--text-secondary);
            font-style: italic;
        }

        .rating-stars {
            display: flex;
            flex-wrap: wrap;
            gap: 0.15rem;
            margin-top: 0.25rem;
            cursor: pointer;
            position: relative;
        }

        .rating-stars .star {
            font-size: 0.9rem;
        }
        
        .current-rating-display {
            margin-top: 0.75rem;
            text-align: center;
            font-size: 1rem;
            color: var(--text);
        }

        #ratingStars {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.3rem;
            margin-top: 1rem;
        }

        #ratingStars .star {
            cursor: pointer;
        }
        
        .movie-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }
        
        /* Search container styles */
        .search-container {
            margin-right: 20px;
        }
        
        .search-container form {
            display: flex;
            align-items: center;
        }
        
        .search-container input {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            transition: all 0.3s ease;
        }
        
        .search-container input:focus {
            outline: none;
            border-color: var(--primary);
            width: 240px;
        }
        
        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* User dropdown styles */
        .user-dropdown {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .label, .username {
            font-size: 14px; /* Make both the same size */
            color: var(--text);
        }
        
        .label {
            color: var(--text-secondary);
            margin-right: -4px;
        }
        
        .username {
            font-weight: 600;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: rgba(30, 30, 30, 0.95);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-medium);
            min-width: 150px;
            z-index: 100;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: var(--text);
            text-decoration: none;
            transition: all var(--transition-fast);
        }
        
        .dropdown-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--primary);
        }

        /* Navbar styling */
        nav {
            display: flex;
            justify-content: center;
            flex: 1;
            margin-left: 215px; /* Add this line to move nav links to the right */
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: rgba(0, 0, 0, 0.8);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">MoodFlix</div>
        <nav>
            <a href="{{ url_for('home') }}">Home</a>
            <a href="{{ url_for('watchlist') }}" class="active">My Watchlist</a>
            <a href="{{ url_for('moods') }}">Mood</a>
            <a href="{{ url_for('explore') }}">Explore</a>
        </nav>
        <div class="search-profile">
            <div class="search-container">
                <form action="{{ url_for('search') }}" method="GET">
                    <input type="text" name="query" placeholder="Search movies..." required>
                </form>
            </div>
            <div class="user-dropdown" onclick="toggleDropdown()">
                <span class="label">Logged in as</span>
                <span class="username">{{ username }}</span>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="{{ url_for('profile') }}">View Profile</a>
                    <a href="{{ url_for('logout') }}">Logout</a>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="watchlist-container">
            <div class="watchlist-header">
                <h1 class="watchlist-title">My Watchlist</h1>
                <button class="create-folder-btn" onclick="openCreateFolderModal()">
                    <span class="folder-icon">📁</span>
                    <span>Create Folder</span>
                </button>
            </div>
            
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="watched">Watched</button>
                <button class="filter-btn" data-filter="unwatched">Unwatched</button>
            </div>
            
            {% if watchlist.movies_by_folder %}
                {% for folder_name, movies in watchlist.movies_by_folder.items() %}
                <div class="folder-section" data-folder="{{ folder_name }}">
                    <div class="folder-header" onclick="toggleFolder(this)">
                        <div class="folder-title-container">
                            <button class="toggle-folder">▼</button>
                            <h2 class="folder-title">
                                <span class="folder-icon">📁</span>
                                <span>{{ folder_name }}</span>
                                <span class="movie-count">({{ movies|length }} movies)</span>
                            </h2>
                        </div>
                        {% if folder_name != "Uncategorized" %}
                        <div class="folder-actions" onclick="event.stopPropagation();">
                            <button class="folder-btn" onclick="openRenameFolderModal('{{ folder_name }}')">Rename</button>
                            <button class="folder-btn" onclick="openDeleteFolderModal('{{ folder_name }}')">Delete</button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="folder-content">
                        <div class="watchlist-grid">
                            {% for movie in movies %}
                            <div class="watchlist-card" data-watched="{{ movie.is_watched }}" onclick="window.location.href='{{ url_for('view_movie', title=movie.title) }}'">
                                {% if movie.is_watched %}
                                <div class="watchlist-status watched-badge">Watched</div>
                                {% else %}
                                <div class="watchlist-status unwatched-badge">Unwatched</div>
                                {% endif %}
                                
                                <img src="{{ movie.poster_url }}" alt="{{ movie.title }} poster" class="watchlist-poster">
                                
                                <div class="watchlist-info">
                                    <h3 class="watchlist-title">{{ movie.title }}</h3>
                                    <p class="watchlist-genre">{{ movie.genre }}</p>
                                    <p class="watchlist-rating">{{ movie.rating }}/10</p>
                                    
                                    {% if movie.is_watched %}
                                    <div class="rating-container">
                                        <div class="rating-label" onclick="rateMovie('{{ movie.title }}'); event.stopPropagation();">
                                            <span class="rating-label-text">My Rating:</span>
                                            <span class="rating-value">
                                                {% if movie.user_rating > 0 %}
                                                    {{ movie.user_rating }}/10
                                                {% else %}
                                                    Not rated
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% if movie.user_rating > 0 %}
                                        <div class="rating-stars" onclick="rateMovie('{{ movie.title }}'); event.stopPropagation();">
                                            {% for i in range(10) %}
                                                {% if i < movie.user_rating %}
                                                <span class="star active">★</span>
                                                {% else %}
                                                <span class="star">★</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="rating-container">
                                        <div class="rating-label">
                                            <span class="rating-label-text">My Rating:</span>
                                            <span class="rating-value unwatched">Unwatched</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="card-actions">
                                        <button class="card-btn" onclick="openMoveToFolderModal('{{ movie.title }}'); event.stopPropagation();">Move</button>
                                        <button class="card-btn" onclick="removeFromWatchlist('{{ movie.title }}'); event.stopPropagation();">Remove</button>
                                        
                                        {% if not movie.is_watched %}
                                        <button class="card-btn primary" onclick="markAsWatched('{{ movie.title }}'); event.stopPropagation();">✓ Watched</button>
                                        {% else %}
                                        <button class="card-btn" onclick="rateMovie('{{ movie.title }}'); event.stopPropagation();">Rate</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <h3>Your watchlist is empty</h3>
                    <p>Start adding movies to your watchlist to keep track of what you want to watch.</p>
                    <a href="{{ url_for('home') }}" class="empty-state-btn">Browse Movies</a>
                </div>
            {% endif %}
        </div>
    </main>
    
    <!-- Create Folder Modal -->
    <div id="createFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Folder</h2>
                <button class="modal-close" onclick="closeModal('createFolderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="newFolderName" class="modal-input" placeholder="Enter folder name">
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('createFolderModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Rename Folder Modal -->
    <div id="renameFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Rename Folder</h2>
                <button class="modal-close" onclick="closeModal('renameFolderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="oldFolderName">
                <input type="text" id="updatedFolderName" class="modal-input" placeholder="Enter new folder name">
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('renameFolderModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="renameFolder()">Rename</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Folder Modal -->
    <div id="deleteFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Folder</h2>
                <button class="modal-close" onclick="closeModal('deleteFolderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="folderToDelete">
                <p>Are you sure you want to delete this folder? All movies will be moved to "Uncategorized".</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('deleteFolderModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="deleteFolder()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Move to Folder Modal -->
    <div id="moveToFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Move to Folder</h2>
                <button class="modal-close" onclick="closeModal('moveToFolderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="movieToMove">
                <select id="targetFolder" class="modal-select">
                    <option value="Uncategorized">Uncategorized</option>
                    {% for folder in watchlist.folders %}
                        <option value="{{ folder.name }}">{{ folder.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('moveToFolderModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="moveToFolder()">Move</button>
            </div>
        </div>
    </div>
    
    <!-- Rate Movie Modal -->
    <div id="rateMovieModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Rate Movie</h2>
                <button class="modal-close" onclick="closeModal('rateMovieModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="movieToRate">
                <p>How would you rate this movie?</p>
                <div class="rating-stars" id="ratingStars">
                    <span class="star" data-rating="1" onclick="setRating(1)">★</span>
                    <span class="star" data-rating="2" onclick="setRating(2)">★</span>
                    <span class="star" data-rating="3" onclick="setRating(3)">★</span>
                    <span class="star" data-rating="4" onclick="setRating(4)">★</span>
                    <span class="star" data-rating="5" onclick="setRating(5)">★</span>
                    <span class="star" data-rating="6" onclick="setRating(6)">★</span>
                    <span class="star" data-rating="7" onclick="setRating(7)">★</span>
                    <span class="star" data-rating="8" onclick="setRating(8)">★</span>
                    <span class="star" data-rating="9" onclick="setRating(9)">★</span>
                    <span class="star" data-rating="10" onclick="setRating(10)">★</span>
                </div>
                <div class="current-rating-display">Rating: <span id="currentRatingValue">0</span>/10</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('rateMovieModal')">Cancel</button>
                <button class="modal-btn confirm" onclick="submitRating()">Submit</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script>
        // Save folder collapse state to localStorage
        function saveFolderState(folderName, isCollapsed) {
            const folderStates = JSON.parse(localStorage.getItem('folderStates') || '{}');
            folderStates[folderName] = isCollapsed;
            localStorage.setItem('folderStates', JSON.stringify(folderStates));
        }
        
        // Load folder collapse states from localStorage
        function loadFolderStates() {
            const folderStates = JSON.parse(localStorage.getItem('folderStates') || '{}');
            const folderSections = document.querySelectorAll('.folder-section');
            
            folderSections.forEach(section => {
                const folderName = section.dataset.folder;
                if (folderStates[folderName]) {
                    section.classList.add('collapsed');
                }
            });
        }
        
        // Toggle folder collapse/expand
        function toggleFolder(header) {
            const folderSection = header.closest('.folder-section');
            const folderContent = folderSection.querySelector('.folder-content');
            const folderName = folderSection.dataset.folder;
            
            if (folderSection.classList.contains('collapsed')) {
                // Expanding
                folderSection.classList.remove('collapsed');
                folderContent.style.display = 'block';
                setTimeout(() => {
                    folderContent.style.height = 'auto';
                    folderContent.style.opacity = '1';
                    folderContent.style.padding = '1.5rem';
                }, 10);
            } else {
                // Collapsing
                folderContent.style.height = '0';
                folderContent.style.opacity = '0';
                folderContent.style.padding = '0';
                setTimeout(() => {
                    folderSection.classList.add('collapsed');
                    folderContent.style.display = 'none';
                }, 300);
            }
            
            // Save state to localStorage
            saveFolderState(folderName, folderSection.classList.contains('collapsed'));
        }
        
        // Filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved folder states
            loadFolderStates();
            
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    const filter = this.dataset.filter;
                    const folderSections = document.querySelectorAll('.folder-section');
                    
                    folderSections.forEach(folderSection => {
                        const cards = folderSection.querySelectorAll('.watchlist-card');
                        let visibleCards = 0;
                        
                        cards.forEach(card => {
                            if (filter === 'all') {
                                card.style.display = 'flex';
                                visibleCards++;
                            } else if (filter === 'watched' && card.dataset.watched === '1') {
                                card.style.display = 'flex';
                                visibleCards++;
                            } else if (filter === 'unwatched' && card.dataset.watched === '0') {
                                card.style.display = 'flex';
                                visibleCards++;
                            } else {
                                card.style.display = 'none';
                            }
                        });
                        
                        // Hide the entire folder section if no movies match the filter
                        if (visibleCards === 0) {
                            folderSection.style.display = 'none';
                        } else {
                            folderSection.style.display = 'block';
                        }
                    });
                });
            });
        });
        
        // Modal functionality
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function openCreateFolderModal() {
            document.getElementById('newFolderName').value = '';
            openModal('createFolderModal');
        }
        
        function openRenameFolderModal(folderName) {
            document.getElementById('oldFolderName').value = folderName;
            document.getElementById('updatedFolderName').value = folderName;
            openModal('renameFolderModal');
        }
        
        function openDeleteFolderModal(folderName) {
            document.getElementById('folderToDelete').value = folderName;
            openModal('deleteFolderModal');
        }
        
        function openMoveToFolderModal(movieTitle) {
            document.getElementById('movieToMove').value = movieTitle;
            openModal('moveToFolderModal');
        }
        
        function rateMovie(movieTitle) {
            document.getElementById('movieToRate').value = movieTitle;
            // Reset stars
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach(star => star.classList.remove('active'));
            
            // Reset current rating value
            document.getElementById('currentRatingValue').textContent = '0';
            currentRating = 0;
            
            openModal('rateMovieModal');
        }
        
        let currentRating = 0;
        
        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach(star => {
                if (parseInt(star.dataset.rating) <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            // Update the displayed rating value
            document.getElementById('currentRatingValue').textContent = rating;
        }
        
        // Toast functionality
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // API calls
        function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            
            if (!folderName) {
                showToast('Please enter a folder name', 'error');
                return;
            }
            
            fetch('/api/folder/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    folder_name: folderName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Folder created successfully');
                    closeModal('createFolderModal');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function renameFolder() {
            const oldName = document.getElementById('oldFolderName').value;
            const newName = document.getElementById('updatedFolderName').value.trim();
            
            if (!newName) {
                showToast('Please enter a folder name', 'error');
                return;
            }
            
            fetch('/api/folder/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_name: oldName,
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Folder renamed successfully');
                    closeModal('renameFolderModal');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function deleteFolder() {
            const folderName = document.getElementById('folderToDelete').value;
            
            fetch('/api/folder/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    folder_name: folderName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Folder deleted successfully');
                    closeModal('deleteFolderModal');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function moveToFolder() {
            const movieTitle = document.getElementById('movieToMove').value;
            const folderName = document.getElementById('targetFolder').value;
            
            fetch('/api/watchlist/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_title: movieTitle,
                    folder_name: folderName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Movie moved successfully');
                    closeModal('moveToFolderModal');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function markAsWatched(movieTitle) {
            fetch('/api/watchlist/watched', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_title: movieTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Movie marked as watched');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function submitRating() {
            const movieTitle = document.getElementById('movieToRate').value;
            
            if (currentRating === 0) {
                showToast('Please select a rating', 'error');
                return;
            }
            
            fetch('/api/watchlist/watched', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_title: movieTitle,
                    rating: currentRating
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Rating submitted successfully');
                    closeModal('rateMovieModal');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        function toggleDropdown() {
            const menu = document.getElementById('userDropdown');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }
        
        function removeFromWatchlist(movieTitle) {
            fetch('/api/watchlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_title: movieTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Movie removed from watchlist');
                    window.location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred', 'error');
                console.error('Error:', error);
            });
        }
        
        window.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && !e.target.closest('.user-dropdown')) {
                dropdown.style.display = 'none';
            }
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
